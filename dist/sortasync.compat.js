!function(r,e){"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?module.exports=e():r.Sortasync=e()}(this,function(){var r=function(r){function e(t){if(n[t])return n[t].exports;var o=n[t]={exports:{},id:t,loaded:!1};return r[t].call(o.exports,o,o.exports,e),o.loaded=!0,o.exports}var n={};return e.m=r,e.c=n,e.p="",e(0)}([function(r,e){"use strict";function n(r){if(Array.isArray(r)){for(var e=0,n=Array(r.length);e<r.length;e++)n[e]=r[e];return n}return Array.from(r)}function t(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}var o=function(){function r(r,e){var n=[],t=!0,o=!1,a=void 0;try{for(var i,u=r[Symbol.iterator]();!(t=(i=u.next()).done)&&(n.push(i.value),!e||n.length!==e);t=!0);}catch(c){o=!0,a=c}finally{try{!t&&u["return"]&&u["return"]()}finally{if(o)throw a}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return r(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),a=function(){function r(r,e){for(var n=0;n<e.length;n++){var t=e[n];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(r,t.key,t)}}return function(e,n,t){return n&&r(e.prototype,n),t&&r(e,t),e}}(),i=function(){function r(e){var n=this;t(this,r),this.program=new Map;for(var a in e)switch(a){case"_args":e[a].forEach(function(r,e){n.program.set(r,{type:"argument",index:e})});break;default:var i=this.parseOperation(e[a]),u=o(i,2),c=u[0],s=u[1];this.program.set(a,{type:"operation",operation:c,dependencies:s})}}return a(r,[{key:"exec",value:function(){var r=this,e=Array.from(arguments),t=new Map,o=void 0,a=new Promise(function(r){return o=r});return this.program.forEach(function(o,i){var u=void 0;switch(o.type){case"argument":u=e[o.index];break;case"operation":u=a.then(function(){var r=o.dependencies.map(function(r){return t.get(r)});return Promise.all(r)}).then(function(r){return o.operation.apply(o,n(r))})["catch"](function(e){return r.normalizeRejection(e,i)})}t.set(i,u)}),o(),Promise.all(t.values()).then(function(e){return r.mapResults(e)})}},{key:"mapResults",value:function(r){var e=this.program.keys(),n={};return r.forEach(function(r){n[e.next().value]=r}),n}},{key:"normalizeRejection",value:function(r,e){var n=void 0;if(r instanceof Error)n=r,n.sortasync=n.sortasync||{step:e,reason:null};else{var t="string"==typeof r?r:"";n=new Error(t),n.name="RejectionError",n.sortasync={step:e,reason:r}}throw n}},{key:"parseOperation",value:function(r){var e=/^([^\(^\)]+?)\s*=>/,n=/^[^\(]*\(\s*([^\)]*)\)/m,t=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/gm,o=r,a=[];if("function"==typeof r&&r.length){var i=Function.prototype.toString.call(r)+" ",u=i.replace(t,""),c=u.match(e)||u.match(n),s=c?c[1].split(","):[];s.forEach(function(r){a.push(r.trim())})}else if(Array.isArray(r)){var f=r.length-1;o=r[f],a=r.slice(0,f)}return[o,a]}}]),r}();r.exports=i}]);return r});